<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laptop Inventory</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-ui-dist/jquery-ui.min.css">
</head>
<body>

<div class="sidebar" id="filterPanel">
    <h3 class="filter-title">Filters</h3>
    <button id="closeSidebar" onclick="toggleSidebar()">✖ Close</button>
    <div class="filter-section">
        <label>📅 Auction Date</label>
        <input type="date" id="dateFilter">
    </div>
    <div class="filter-section">
        <label>🏢 Brand</label>
        <input type="text" id="brandFilter" placeholder="Brand">
    </div>
    <div class="filter-section">
        <label>🔖 Model</label>
        <input type="text" id="modelFilter" placeholder="Model">
    </div>
    <div class="filter-section">
        <label>💾 RAM (GB)</label>
        <input type="number" id="ramFilter" placeholder="Min">
    </div>
    <div class="filter-section">
        <label>🔎 Processor</label>
        <input type="text" id="processorFilter" placeholder="Processor">
    </div>
    <div class="filter-section">
        <label>💽 Storage</label>
        <input type="text" id="storageFilter" placeholder="SSD/HDD">
    </div>
    <div class="filter-section">
        <label>📏 Screen Size (inches)</label>
        <input type="number" id="screenSizeFilter" placeholder="Min">
    </div>
    <div class="filter-section">
        <label>⭐ Rating (0-10)</label>
        <input type="number" id="ratingFilter" min="0" max="10" step="0.1">
    </div>
    <div class="filter-section">
        <label>💰 Boncoin Price (€)</label>
        <input type="number" id="priceFilter" placeholder="Max">
    </div>
    <div class="filter-section">
        <label>✅ Recommended</label>
        <select id="recommendedFilter">
            <option value="">Any</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select>
    </div>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="resetFilters()">Reset</button>
</div>
<div class="results-panel" id="resultsPanel">
    <button id="filterToggle">Filters</button>
    Laptops Found: <span id="resultsCount">0</span>
</div>
<!-- ⭐ Add the favorites panel here -->
<div class="favorites-panel">
    <h3>
        ⭐ Favorite Laptops (<span id="favoriteCount">0</span>)
        <button class="icon-btn delete-btn" onclick="clearFavorites()" title="Delete All Favorites">🗑️</button>
        <button class="icon-btn open-btn" onclick="openAllFavorites()" title="Open All URLs">🌍</button>
    </h3>
    <div id="favoriteList" class="favorite-grid"></div>
</div>


<div class="scrollable-table-container">
    <table class="scrollable-table">
        <thead>
        <tr>
            <th>🖼 Image</th>
            <th>📌 Lot</th>
            <th>🏢 Brand</th>
            <th>🔖 Model</th>
            <th>🔎 Processor</th>
            <th>💾 RAM</th>
            <th>💽 Storage</th>
            <th>📏 Screen Size</th>
            <th>💰 Boncoin Price (€)</th>
            <th>🏢 Seller</th>
            <th>✅ Recommended</th>
        </tr>
        </thead>
        <tbody id="laptopTable"></tbody>
    </table>
</div>

<script>
    function toggleSidebar() {
        document.getElementById("filterPanel").classList.toggle("active");
        document.getElementById("filterToggle").style.display =
            document.getElementById("filterPanel").classList.contains("active") ? "none" : "block";
    }

    document.getElementById("filterToggle").addEventListener("click", toggleSidebar);

    async function fetchLaptops(filters = {}) {
        let filteredParams = Object.fromEntries(
            Object.entries(filters).filter(([_, value]) => value !== "")
        );
        let query = new URLSearchParams(filteredParams).toString();
        let endpoint = query
            ? `http://localhost:9090/api/laptops/filter?${query}`
            : "http://localhost:9090/api/laptops";

        console.log("🔎 Fetching laptops from:", endpoint);

        try {
            let response = await fetch(endpoint);
            if (!response.ok) {
                console.error("❌ API Error:", response.statusText);
                document.getElementById("laptopTable").innerHTML =
                    "<tr><td colspan='11' class='text-center text-danger'>❌ API Error</td></tr>";
                return;
            }

            let laptops = await response.json();
            document.getElementById("resultsCount").textContent = laptops.length;
            console.log("✅ Received laptops:", laptops.length, "items");

            let tableBody = document.getElementById("laptopTable");
            tableBody.innerHTML = laptops.length
                ? laptops.map((laptop, index) => {
                    let isFavorite = checkIfFavorite(laptop.id);
                    // **Filter out bad data**
                    let brand = (laptop.brand && !["N/A", "Unknown", ""].includes(laptop.brand)) ? laptop.brand : "";
                    let model = (laptop.model && !["N/A", "Unknown", ""].includes(laptop.model)) ? laptop.model : "";
                    let processorBrand = (laptop.processor_brand && !["N/A", "Unknown", ""].includes(laptop.processor_brand)) ? laptop.processor_brand : "";
                    let processorModel = (laptop.processor_model && !["N/A", "Unknown", ""].includes(laptop.processor_model)) ? laptop.processor_model : "";

                    // If essential details are missing, don't show the row
                    if (!brand && !model && !processorBrand && !processorModel) return "";

                    return `

                    <tr class="laptop-row" onclick="toggleDetails(${index}, event)">

                        <td><img src="${laptop.img_url}" style="max-width: 80px;"></td>
                        <td><a href="${laptop.lot_url}" target="_blank">${laptop.lot_number}</a></td>
                        <td>${brand}</td>
                        <td>${model}</td>
                        <td>${processorBrand} ${processorModel}</td>
                        <td>${laptop.ram_size ? laptop.ram_size + 'GB' : ''}</td>
                        <td>${laptop.storage_type || ''} ${laptop.storage_capacity ? laptop.storage_capacity + 'GB' : ''}</td>
                        <td>${laptop.screen_size ? laptop.screen_size + ' inches' : ''}</td>
                        <td><b>${laptop.bon_coin_estimation || ''}</b></td>
                        <td>${laptop.maison_enchere || ''}</td>
                        <td>${laptop.recommended_to_buy ? '✅ Yes' : '❌ No'}</td>
                         <td>
                    <button class="favorite-btn" onclick="toggleFavorite(${laptop.id})">
                        ${isFavorite ? '❤️' : '🤍'}
                    </button>
                </td>
                    </tr>
                    <tr class="details-row" id="details-${index}">
                        <td colspan="11" class="details-content">
                            <b>📋 Description:</b> ${laptop.description || "No description available"} <br>
                            <b>💻 Full Specifications:</b> <br>
                            ${processorBrand ? `🔎 Processor: ${processorBrand} ${processorModel} (${laptop.processor_cores} Cores, ${laptop.processor_clock_speed} GHz) <br>` : ""}
                            ${laptop.ram_size ? `💾 RAM: ${laptop.ram_size}GB ${laptop.ram_type} <br>` : ""}
                            ${laptop.storage_type ? `💽 Storage: ${laptop.storage_type} ${laptop.storage_capacity}GB (${laptop.storage_speed} MB/s) <br>` : ""}
                            ${laptop.gpu_type ? `🎮 GPU: ${laptop.gpu_type} ${laptop.gpu_model} (${laptop.gpu_vram}GB VRAM) <br>` : ""}
                            ${laptop.screen_size ? `🖥️ Screen: ${laptop.screen_size}" (${laptop.screen_resolution})<br>` : ""}
                            ${laptop.battery_life ? `🔋 Battery Life: ${laptop.battery_life} <br>` : ""}
                            ${laptop.weight ? `⚡ Weight: ${laptop.weight}kg <br>` : ""}
                            ${laptop.operating_system ? `💻 OS: ${laptop.operating_system} <br>` : ""}
                            ${laptop.chassis_material ? `🏗️ Chassis Material: ${laptop.chassis_material} <br>` : ""}
                            ${laptop.fingerprint_sensor ? `🔒 Security: Fingerprint ✅<br>` : ""}
                            ${laptop.face_recognition ? `🔒 Security: Face Recognition ✅<br>` : ""}
                            ${laptop.connectivity ? `📡 Connectivity: ${laptop.connectivity} <br>` : ""}
                            ${laptop.etat_produit_image ? `<p>${laptop.etat_produit_image}</p>` : "No additional images"} <br>
                            ⭐ Score: ${laptop.note_sur_10}/10 <br>
                            ✅ Recommended to Buy: ${laptop.recommended_to_buy ? "Yes ✅" : "No ❌"}
                        </td>
                    </tr>

                `;
                }).join("")
                : "<tr><td colspan='11' class='text-center text-danger'>⚠️ No laptops found.</td></tr>";
        } catch (error) {
            console.error("❌ Fetch error:", error);
            document.getElementById("laptopTable").innerHTML =
                "<tr><td colspan='11' class='text-center text-danger'>❌ Error loading data.</td></tr>";
        }
    }

    function toggleDetails(index, event) {
        // Prevent toggling if the click event originates from the favorite button
        if (event.target.classList.contains("favorite-btn")) {
            return;
        }

        let detailsRow = document.getElementById(`details-${index}`);
        detailsRow.style.display = detailsRow.style.display === "none" ? "table-row" : "none";
    }



    function applyFilters() {
        let filters = Object.fromEntries(
            [...document.querySelectorAll(".filter-section input, .filter-section select")]
                .map(el => [el.id.replace("Filter", ""), el.value.trim()])
                .filter(([_, value]) => value !== "") // Remove empty filters
        );

        fetchLaptops(filters);
        toggleSidebar();
    }






    function resetFilters() {
        document.querySelectorAll(".filter-section input, .filter-section select").forEach(el => el.value = "");
        fetchLaptops();
    }

    async function loadAutocompleteData() {
        let response = await fetch("http://localhost:9090/api/laptops");
        let laptops = await response.json();

        let brands = [...new Set(laptops.map(l => l.brand))];
        let models = [...new Set(laptops.map(l => l.model))];
        let processors = [...new Set(laptops.map(l => l.processorBrand + " " + l.processorModel))];
        let storages = [...new Set(laptops.map(l => l.storageType))];

        $("#brandFilter").autocomplete({ source: brands });
        $("#modelFilter").autocomplete({ source: models });
        $("#processorFilter").autocomplete({ source: processors });
        $("#storageFilter").autocomplete({ source: storages });
    }


    $(document).ready(() => {
        fetchLaptops();
        loadAutocompleteData();
    });
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelector("button[onclick='applyFilters()']").addEventListener("click", applyFilters);
        fetchLaptops(); // Load initial laptops
    });

    function checkIfFavorite(laptopId) {
        let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
        return favorites.includes(laptopId);
    }

    async function toggleFavorite(laptopId) {
        try {
            // Get the button element
            let button = document.querySelector(`button[onclick="toggleFavorite(${laptopId})"]`);

            // Determine current state and toggle it
            let isFavorite = button.innerHTML.trim() === "❤️"; // Check if currently favorited

            // Send API request to toggle favorite
            let response = await fetch(`http://localhost:9090/api/laptops/favorite/${laptopId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ favorite: !isFavorite }) // Toggle favorite status
            });

            if (!response.ok) {
                throw new Error(`❌ API request failed: ${response.status} ${response.statusText}`);
            }

            console.log("✅ Favorite updated successfully.");

            // ✅ Toggle icon instantly without reloading
            button.innerHTML = !isFavorite ? "❤️" : "🤍";

            updateFavoritePanel(); // Refresh the favorite list panel
        } catch (error) {
            console.error("❌ Error updating favorite:", error);
        }
    }




    // ✅ Open All Favorite Laptop URLs in New Tabs
    function openAllFavorites() {
        fetch("http://localhost:9090/api/laptops/favorites")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch favorites");
                }
                return response.json();
            })
            .then(favorites => {
                if (favorites.length === 0) {
                    alert("No favorite laptops to open.");
                    return;
                }

                // ✅ Open all URLs in a new background tab
                for (let i = 0; i < favorites.length; i++) {
                    let laptop = favorites[i];

                    if (laptop.lot_url && laptop.lot_url.trim()) {
                        let newTab = window.open("", "_blank"); // Open empty tab first
                        newTab.location.href = laptop.lot_url; // Set URL to avoid blocking
                    }
                }
            })
            .catch(error => console.error("❌ Error opening favorite URLs:", error));
    }




    async function clearFavorites() {
        try {
            let response = await fetch("http://localhost:9090/api/laptops/favorites", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            });

            if (!response.ok) {
                console.error("❌ Failed to delete favorites:", response.status);
                alert("Failed to clear favorites. Please try again.");
                return;
            }

            let message = await response.text();
            console.log("✅ Favorites cleared successfully:", message);
            alert(message);

            // ✅ Clear UI: Reset favorite panel
            updateFavoritePanel();

            // ✅ Clear favorite icons in the table
            document.querySelectorAll(".favorite-btn").forEach(btn => {
                btn.innerHTML = "🤍"; // Reset all favorite icons to unselected
            });

        } catch (error) {
            console.error("❌ Error clearing favorites:", error);
        }
    }




    async function updateFavoritePanel() {
        try {
            let response = await fetch("http://localhost:9090/api/laptops/favorites");
            if (!response.ok) throw new Error("Failed to fetch favorites");

            let favorites = await response.json();
            console.log("✅ Loaded favorites:", favorites);

            let favoriteList = document.getElementById("favoriteList");
            let favoriteCount = document.getElementById("favoriteCount");

            favoriteCount.textContent = favorites.length;

            if (favorites.length === 0) {
                favoriteList.innerHTML = "<p class='no-favorites'>No favorites yet.</p>";
            } else {
                favoriteList.innerHTML = favorites.map(laptop => `
                <div class="favorite-item">
                    <img src="${laptop.img_url || 'default-image.png'}" alt="Laptop" class="favorite-img">
                    <p>${laptop.brand || 'Unknown'} ${laptop.model || 'Unknown'} (${laptop.maison_enchere || 'Unknown Seller'})</p>
                    <a href="${laptop.lot_url || '#'}" target="_blank">🔗 Open</a>
                </div>
            `).join("");
            }
        } catch (error) {
            console.error("❌ Error loading favorites:", error);
        }
    }



    // ✅ Call this function when page loads
    document.addEventListener("DOMContentLoaded", updateFavoritePanel);



    // Initialize favorite panel on load
    updateFavoritePanel();

</script>
</body>
</html>
